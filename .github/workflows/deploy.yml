name: deploy
on:
  workflow_dispatch:
    inputs:
      version:
        description: "–í–µ—Ä—Å–∏—è –¥–ª—è –¥–µ–ø–ª–æ—è (1, 2, 13 ‚Ä¶)"
        required: true

jobs:
  prod:
    runs-on: ubuntu-latest
    env:
      IMAGE: cr.yandex/${{ secrets.YC_REGISTRY }}/app:${{ inputs.version }}_latest
    steps:
      - name: login to container registry
        run: |
          IMAGE="cr.yandex/${{ secrets.YC_REGISTRY }}/app:${{ inputs.version }}_latest"
          docker login cr.yandex -u oauth -p ${{ secrets.YC_OAUTH_TOKEN }}
          docker manifest inspect "$IMAGE" >/dev/null

      - name: deploy to vm
        uses: appleboy/ssh-action@v1
        with:
          host:     ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key:      ${{ secrets.VM_SSH_KEY }}
          script: |
            IMAGE="cr.yandex/${{ secrets.YC_REGISTRY }}/app:${{ inputs.version }}_latest"

            docker login cr.yandex -u oauth -p '${{ secrets.YC_OAUTH_TOKEN }}'
            docker pull "$IMAGE"

            docker stop app || true && docker rm app || true
            docker run -d --name app -p 80:3000 "$IMAGE"

      - name: open deploy issue
        run: |
          ISSUE=$(gh issue list \
                    --state all \
                    --search "Release ${{ inputs.version }}" \
                    --json number \
                    -q '.[0].number')

          if [ -n "$ISSUE" ]; then
            gh issue comment "$ISSUE" \
              --body "**üöÄ –í—ã–∫–∞—Ç –≤ –ø—Ä–æ–¥**: $(date)\n**–ê–≤—Ç–æ—Ä:** ${{ github.actor }}"
          else
            echo "‚ö†Ô∏è  Issue 'Deploy ${{ inputs.version }}' –Ω–µ –Ω–∞–π–¥–µ–Ω."
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}